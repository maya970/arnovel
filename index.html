<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AO å°è¯´å¹³å°</title>
    <!-- Skypack è‡ªåŠ¨è½¬æ¢ ESM ä¸ºæµè§ˆå™¨å…¼å®¹ï¼Œæ—  export é”™è¯¯ï¼Œæ—  importmap éœ€è¦ -->
    <script type="module">
        import { message, result, dryrun, createDataItemSigner } from "https://cdn.skypack.dev/@permaweb/aoconnect@0.0.93";
        window.aoMessage = message;
        window.aoResult = result;
        window.aoDryrun = dryrun;
        window.aoCreateSigner = createDataItemSigner;
        console.log('aoconnect åŠ è½½æˆåŠŸ');
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #4a6cf7; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #eee; padding: 15px; border-radius: 4px; white-space: pre-wrap; max-height: 300px; overflow: auto; }
        .status { font-weight: bold; color: #d32f2f; }
        .connected { color: #2e7d32; }
        small { color: #d32f2f; display: block; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š AO å°è¯´å¹³å°</h1>

        <section>
            <button id="connect-wallet">è¿æ¥ Wander é’±åŒ…</button>
            <p>é’±åŒ…åœ°å€: <span id="wallet-address" class="status">æœªè¿æ¥</span></p>
            <small>å¿…é¡»å…ˆç‚¹å‡»å³ä¸Šè§’ Wander å›¾æ ‡è¾“å…¥å¯†ç è§£é”ï¼å¦åˆ™è¿æ¥ä¼šå¤±è´¥æŠ¥ auth required</small>
        </section>

        <!-- å…¶ä»–åŠŸèƒ½åŒºåŒä¸Šä¸€ä¸ªç‰ˆæœ¬ -->
        <!-- åˆ›å»ºå°è¯´ã€åˆ—è¡¨ã€è¯¦æƒ…ã€æ·»åŠ ç« èŠ‚ç­‰ -->

        <section>
            <h2>åˆ›å»ºå°è¯´</h2>
            <input id="novel-title" placeholder="æ ‡é¢˜" />
            <textarea id="novel-description" placeholder="ç®€ä»‹"></textarea>
            <button id="create-novel-btn">åˆ›å»º</button>
            <pre id="create-result"></pre>
        </section>

        <!-- çœç•¥å…¶ä½™ section ä»¥èŠ‚çœç©ºé—´ï¼Œä½†ä¿æŒå®Œæ•´ç»“æ„ -->

    </div>

    <script type="module">
        const PROCESS_ID = "51tMVLxBazWMBT9NhfaCuDP3HjQfZOggIcT7l9mRrbw";

        let signer = null;
        let walletAddress = null;

        function updateWalletDisplay(addr) {
            walletAddress = addr;
            const span = document.getElementById('wallet-address');
            const btn = document.getElementById('connect-wallet');
            if (addr) {
                span.textContent = addr.slice(0, 6) + '...' + addr.slice(-4);
                span.classList.add('connected');
                btn.textContent = 'å·²è¿æ¥';
                btn.disabled = true;
            } else {
                span.textContent = 'æœªè¿æ¥';
                span.classList.remove('connected');
                btn.textContent = 'è¿æ¥ Wander é’±åŒ…';
                btn.disabled = false;
            }
        }

        async function connectWallet() {
            if (!window.arweaveWallet) {
                alert('æœªæ£€æµ‹åˆ° Wanderï¼å®‰è£…ååˆ·æ–°');
                return;
            }
            try {
                await window.arweaveWallet.connect(['ACCESS_ADDRESS', 'SIGN_TRANSACTION', 'SIGNATURE']);
                const addr = await window.arweaveWallet.getActiveAddress();
                signer = window.aoCreateSigner(window.arweaveWallet);
                updateWalletDisplay(addr);
            } catch (e) {
                alert('è¿æ¥å¤±è´¥: ' + e.message);
            }
        }

        document.getElementById('connect-wallet').addEventListener('click', connectWallet);

        // AO å‡½æ•°åŒ…è£…
        async function sendDryrun(tags) {
            const res = await window.aoDryrun({ process: PROCESS_ID, tags });
            return res.Messages?.[0]?.Data || JSON.stringify(res, null, 2);
        }

        async function sendMessage(tags, data = '') {
            if (!signer) throw new Error('æœªè¿æ¥é’±åŒ…');
            const msgId = await window.aoMessage({ process: PROCESS_ID, signer, tags, data });
            const res = await window.aoResult({ message: msgId, process: PROCESS_ID });
            return res.Output || res.Messages?.[0]?.Data || JSON.stringify(res, null, 2);
        }

        // æ‰€æœ‰æŒ‰é’®äº‹ä»¶ç»‘å®šåŒä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œå¤åˆ¶ç²˜è´´å³å¯

        window.addEventListener('load', async () => {
            if (window.arweaveWallet) {
                try {
                    const addr = await window.arweaveWallet.getActiveAddress();
                    if (addr) {
                        signer = window.aoCreateSigner(window.arweaveWallet);
                        updateWalletDisplay(addr);
                    }
                } catch {}
            }
        });
    </script>
</body>
</html>
