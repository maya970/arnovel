<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Platform 小说平台</title>
    <!-- 关键：使用 aoconnect 的 browser bundle（已打包所有依赖） -->
    <script src="https://unpkg.com/@permaweb/aoconnect/dist/browser.js"></script>
    <!-- common.js 放在后面，确保 aoconnect 已加载 -->
    <script src="common.js"></script>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        input, textarea, button { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        button { background: #0066ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0055cc; }
        pre { background: #f0f0f0; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
        .wallet-address { font-weight: bold; color: #0066ff; }
        label { display: block; margin: 10px 0 5px; }
    </style>
</head>
<body>
    <h1>Novel Platform 小说平台</h1>

    <section id="wallet-section">
        <button id="connect-wallet">连接钱包 (Wander)</button>
        <p>钱包地址: <span id="wallet-address" class="wallet-address">未连接</span></p>
    </section>

    <section id="create-novel">
        <h2>创建小说</h2>
        <input id="novel-title" placeholder="小说标题" />
        <textarea id="novel-description" placeholder="小说简介"></textarea>
        <button id="create-novel-btn">创建小说</button>
        <pre id="create-result"></pre>
    </section>

    <section id="list-novels">
        <h2>所有小说列表</h2>
        <button id="list-novels-btn">获取所有小说</button>
        <pre id="list-result"></pre>
    </section>

    <section id="get-novel">
        <h2>查看小说信息</h2>
        <input id="novel-id" placeholder="小说 ID" />
        <button id="get-novel-btn">查询</button>
        <pre id="novel-result"></pre>
    </section>

    <section id="add-chapter">
        <h2>添加章节（仅作者）</h2>
        <input id="add-novel-id" placeholder="小说 ID" />
        <input id="chapter-title" placeholder="章节标题" />
        <textarea id="chapter-content" placeholder="章节正文内容"></textarea>
        <label><input type="checkbox" id="is-paid" /> 是否付费章节</label>
        <input id="chapter-price" type="number" placeholder="价格（可选，单位：AR 或自定义代币）" />
        <button id="add-chapter-btn">添加章节</button>
        <pre id="add-result"></pre>
    </section>

    <section id="update-chapter">
        <h2>更新章节（仅作者）</h2>
        <input id="update-novel-id" placeholder="小说 ID" />
        <input id="chapter-index" type="number" placeholder="章节序号（从1开始）" />
        <textarea id="new-content" placeholder="新章节内容"></textarea>
        <button id="update-chapter-btn">更新章节</button>
        <pre id="update-result"></pre>
    </section>

    <section id="buy-chapter">
        <h2>购买章节</h2>
        <input id="buy-novel-id" placeholder="小说 ID" />
        <input id="buy-chapter-index" type="number" placeholder="章节序号（从1开始）" />
        <button id="buy-chapter-btn">购买</button>
        <pre id="buy-result"></pre>
    </section>

    <section id="read-chapter">
        <h2>阅读章节</h2>
        <input id="read-novel-id" placeholder="小说 ID" />
        <input id="read-chapter-index" type="number" placeholder="章节序号（从1开始）" />
        <button id="read-chapter-btn">阅读</button>
        <pre id="read-result"></pre>
    </section>

    <section id="get-earnings">
        <h2>我的收益</h2>
        <button id="get-earnings-btn">查询收益</button>
        <pre id="earnings-result"></pre>
    </section>

    <script>
        // 所有事件绑定等页面加载完成后执行
        window.addEventListener('load', () => {
            // 连接钱包按钮
            document.getElementById('connect-wallet').addEventListener('click', window.connectWallet);

            // 以下所有操作都使用 common.js 中暴露的全局函数
            document.getElementById('create-novel-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包！');
                const title = document.getElementById('novel-title').value.trim();
                const desc = document.getElementById('novel-description').value.trim();
                if (!title) return alert('请输入小说标题');
                const tags = [
                    { name: 'Action', value: 'Create-Novel' },
                    { name: 'Title', value: title },
                    { name: 'Description', value: desc }
                ];
                try {
                    const result = await window.aoMessage(tags);
                    document.getElementById('create-result').textContent = result;
                } catch (e) {
                    alert('创建失败：' + e.message);
                }
            });

            document.getElementById('list-novels-btn').addEventListener('click', async () => {
                const tags = [{ name: 'Action', value: 'List-Novels' }];
                try {
                    const result = await window.aoDryrun(tags);
                    document.getElementById('list-result').textContent = result;
                } catch (e) {
                    alert('查询失败：' + e.message);
                }
            });

            document.getElementById('get-novel-btn').addEventListener('click', async () => {
                const id = document.getElementById('novel-id').value.trim();
                if (!id) return alert('请输入小说 ID');
                const tags = [{ name: 'Action', value: 'Get-Novel' }, { name: 'NovelId', value: id }];
                try {
                    const result = await window.aoDryrun(tags);
                    document.getElementById('novel-result').textContent = result;
                } catch (e) {
                    alert('查询失败：' + e.message);
                }
            });

            document.getElementById('add-chapter-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包！');
                const id = document.getElementById('add-novel-id').value.trim();
                const title = document.getElementById('chapter-title').value.trim();
                const content = document.getElementById('chapter-content').value.trim();
                const isPaid = document.getElementById('is-paid').checked ? 'true' : 'false';
                const price = document.getElementById('chapter-price').value || '0';
                if (!id || !title || !content) return alert('请填写完整信息');
                const tags = [
                    { name: 'Action', value: 'Add-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'Title', value: title },
                    { name: 'IsPaid', value: isPaid },
                    { name: 'Price', value: price }
                ];
                try {
                    const result = await window.aoMessage(tags, content);
                    document.getElementById('add-result').textContent = result;
                } catch (e) {
                    alert('添加失败：' + e.message);
                }
            });

            document.getElementById('update-chapter-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包！');
                const id = document.getElementById('update-novel-id').value.trim();
                const index = document.getElementById('chapter-index').value;
                const content = document.getElementById('new-content').value.trim();
                if (!id || !index || !content) return alert('请填写完整信息');
                const tags = [
                    { name: 'Action', value: 'Update-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ];
                try {
                    const result = await window.aoMessage(tags, content);
                    document.getElementById('update-result').textContent = result;
                } catch (e) {
                    alert('更新失败：' + e.message);
                }
            });

            document.getElementById('buy-chapter-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包！');
                const id = document.getElementById('buy-novel-id').value.trim();
                const index = document.getElementById('buy-chapter-index').value;
                if (!id || !index) return alert('请填写完整信息');
                const tags = [
                    { name: 'Action', value: 'Buy-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ];
                try {
                    const result = await window.aoMessage(tags);
                    document.getElementById('buy-result').textContent = result;
                } catch (e) {
                    alert('购买失败：' + e.message);
                }
            });

            document.getElementById('read-chapter-btn').addEventListener('click', async () => {
                const id = document.getElementById('read-novel-id').value.trim();
                const index = document.getElementById('read-chapter-index').value;
                if (!id || !index) return alert('请填写完整信息');
                const tags = [
                    { name: 'Action', value: 'Read-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ];
                try {
                    const result = await window.aoDryrun(tags);
                    document.getElementById('read-result').textContent = result;
                } catch (e) {
                    alert('读取失败：' + e.message);
                }
            });

            document.getElementById('get-earnings-btn').addEventListener('click', async () => {
                const tags = [{ name: 'Action', value: 'Get-Earnings' }];
                try {
                    const result = await window.aoDryrun(tags);
                    document.getElementById('earnings-result').textContent = result;
                } catch (e) {
                    alert('查询失败：' + e.message);
                }
            });
        });
    </script>
</body>
</html>
