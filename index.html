<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AO å°è¯´å¹³å° - å»ä¸­å¿ƒåŒ–é˜…è¯»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#10b981',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center cursor-pointer" onclick="app.navigate('home')">
                    <span class="text-2xl font-bold text-primary">ğŸ“š AO Novel</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="app.navigate('create')" class="text-gray-600 hover:text-primary font-medium">åˆ›ä½œä¸­å¿ƒ</button>
                    <button onclick="app.showMyNovels()" class="text-gray-600 hover:text-primary font-medium">æˆ‘çš„ä½œå“</button>
                    <div id="wallet-container" class="flex items-center space-x-2">
                        <button id="connect-btn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                            è¿æ¥é’±åŒ…
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- View: Home (List Novels) -->
        <div id="view-home" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 id="home-title" class="text-2xl font-bold text-gray-800">çƒ­é—¨å°è¯´</h2>
                <div class="flex space-x-2">
                    <input type="text" id="search-input" placeholder="æœç´¢å°è¯´..." class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                    <button onclick="app.refreshNovels()" class="text-primary hover:underline">åˆ·æ–°</button>
                </div>
            </div>
            <div id="novel-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-10 text-gray-500">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- View: Create Novel -->
        <div id="view-create" class="hidden max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-sm">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">åˆ›å»ºæ–°å°è¯´</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å°è¯´æ ‡é¢˜</label>
                    <input type="text" id="new-novel-title" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç®€ä»‹</label>
                    <textarea id="new-novel-desc" rows="4" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary outline-none"></textarea>
                </div>
                <button onclick="app.createNovel()" class="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">
                    ç«‹å³åˆ›å»º
                </button>
            </div>
        </div>

        <!-- View: Novel Detail -->
        <div id="view-detail" class="hidden space-y-6">
            <button onclick="app.navigate('home')" class="text-gray-500 hover:text-gray-800">â† è¿”å›åˆ—è¡¨</button>
            <div class="bg-white p-8 rounded-xl shadow-sm">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 id="detail-title" class="text-3xl font-bold text-gray-900"></h1>
                        <p id="detail-author" class="text-sm text-gray-500 mt-1"></p>
                    </div>
                    <div id="author-controls" class="hidden">
                        <button onclick="app.showAddChapterModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold shadow-md flex items-center gap-2">
                            <span>ğŸ“</span> æ·»åŠ æ–°ç« èŠ‚
                        </button>
                    </div>
                </div>
                <p id="detail-desc" class="mt-4 text-gray-700 leading-relaxed"></p>
            </div>

            <div class="bg-white p-8 rounded-xl shadow-sm">
                <h3 class="text-xl font-bold mb-4">ç« èŠ‚åˆ—è¡¨</h3>
                <div id="chapter-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- View: Reader -->
        <div id="view-reader" class="hidden max-w-3xl mx-auto">
            <button onclick="app.backToDetail()" class="mb-4 text-gray-500 hover:text-gray-800">â† è¿”å›ç›®å½•</button>
            <div class="bg-white p-10 rounded-xl shadow-lg min-h-[500px]">
                <h1 id="reader-title" class="text-3xl font-bold mb-8 text-center border-b pb-4"></h1>
                <div id="reader-content" class="prose max-w-none text-lg leading-loose text-gray-800 whitespace-pre-wrap"></div>
            </div>
        </div>

    </main>

    <!-- Modals -->
    <div id="modal-add-chapter" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-2xl shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">æ·»åŠ æ–°ç« èŠ‚</h3>
                <button onclick="document.getElementById('modal-add-chapter').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç« èŠ‚æ ‡é¢˜</label>
                    <input id="chapter-title-input" placeholder="è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜" class="w-full border p-2 rounded focus:ring-2 focus:ring-primary outline-none">
                </div>
                
                <div class="flex items-center space-x-4 bg-gray-50 p-3 rounded">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="chapter-is-paid" class="w-4 h-4 text-primary" onchange="document.getElementById('chapter-price-input').disabled = !this.checked">
                        <span class="font-medium">è®¾ä¸ºä»˜è´¹ç« èŠ‚</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <span>ä»·æ ¼:</span>
                        <input id="chapter-price-input" type="number" placeholder="0" disabled class="border p-1 rounded w-24 disabled:bg-gray-200 disabled:text-gray-400">
                        <span class="text-sm text-gray-500 font-bold">AO</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç« èŠ‚å†…å®¹</label>
                    <textarea id="chapter-content-input" rows="12" placeholder="åœ¨æ­¤è¾“å…¥æ­£æ–‡å†…å®¹..." class="w-full border p-2 rounded focus:ring-2 focus:ring-primary outline-none font-mono text-sm"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="document.getElementById('modal-add-chapter').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                    <!-- Fixed: Added explicit Submit button -->
                    <button onclick="app.addChapter()" class="px-6 py-2 bg-primary text-white rounded font-bold hover:bg-indigo-700 shadow">å‘å¸ƒç« èŠ‚</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 z-50">
        Notification
    </div>

    <script type="module">
        import { QuickWallet } from "https://unpkg.com/quick-wallet/dist/quick-wallet.browser.esm.js";
        import { message, createDataItemSigner, dryrun } from "https://unpkg.com/@permaweb/aoconnect@0.0.56/dist/browser.js";

        const PROCESS_ID = "WvjajApbIYiG7_xoUGl5-tLlHWw6x4S-KX1EI0uDA9k";
        // Placeholder for AO Token Process ID. User should replace this.
        const AO_TOKEN_ID = "<AO_TOKEN_PROCESS_ID>"; 

        class App {
            constructor() {
                this.wallet = null;
                this.signer = null;
                this.novels = [];
                this.currentNovel = null;
                this.isMyNovelsMode = false;
                this.init();
            }

            async init() {
                this.bindEvents();
                this.refreshNovels();
            }

            bindEvents() {
                document.getElementById('connect-btn').addEventListener('click', () => this.connectWallet());
                document.getElementById('search-input').addEventListener('input', (e) => this.filterNovels(e.target.value));
            }

            async connectWallet() {
                try {
                    await QuickWallet.connect(["ACCESS_ADDRESS", "SIGN_TRANSACTION"]);
                    this.wallet = await QuickWallet.getActiveAddress();
                    this.signer = createDataItemSigner(QuickWallet);
                    
                    this.updateWalletUI();
                    this.showToast("é’±åŒ…å·²è¿æ¥ âœ…");
                    if (this.currentNovel) this.checkAuthorControls();
                } catch (err) {
                    console.error(err);
                    this.showToast("è¿æ¥å¤±è´¥: " + err.message);
                }
            }

            updateWalletUI() {
                const container = document.getElementById('wallet-container');
                container.innerHTML = `
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-gray-500 font-mono">${this.wallet.slice(0, 6)}...${this.wallet.slice(-4)}</span>
                        <span class="text-xs font-bold text-secondary">å·²è¿æ¥</span>
                    </div>
                `;
            }

            // Navigation
            navigate(viewId) {
                ['home', 'create', 'detail', 'reader'].forEach(v => {
                    document.getElementById(`view-${v}`).classList.add('hidden');
                });
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                if (viewId === 'home') {
                    this.isMyNovelsMode = false;
                    document.getElementById('home-title').textContent = "çƒ­é—¨å°è¯´";
                    this.refreshNovels();
                }
            }

            showMyNovels() {
                if (!this.wallet) return this.showToast("è¯·å…ˆè¿æ¥é’±åŒ…");
                this.navigate('home');
                this.isMyNovelsMode = true;
                document.getElementById('home-title').textContent = "æˆ‘çš„ä½œå“";
                this.renderNovels(this.novels.filter(n => n.Author === this.wallet));
            }

            // Novel Logic
            async refreshNovels() {
                const listEl = document.getElementById('novel-list');
                listEl.innerHTML = '<div class="col-span-full text-center py-10"><div class="loader mx-auto"></div></div>';
                
                try {
                    const res = await dryrun({
                        process: PROCESS_ID,
                        tags: [{ name: "Action", value: "List-Novels" }]
                    });
                    
                    const data = JSON.parse(res.Messages[0].Data);
                    this.novels = Array.isArray(data) ? data : [];
                    
                    if (this.isMyNovelsMode && this.wallet) {
                        this.renderNovels(this.novels.filter(n => n.Author === this.wallet));
                    } else {
                        this.renderNovels(this.novels);
                    }
                } catch (e) {
                    listEl.innerHTML = `<div class="col-span-full text-center text-red-500">åŠ è½½å¤±è´¥: ${e.message}</div>`;
                }
            }

            renderNovels(novels) {
                const listEl = document.getElementById('novel-list');
                if (novels.length === 0) {
                    listEl.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">æš‚æ— å°è¯´</div>';
                    return;
                }

                listEl.innerHTML = novels.map(novel => `
                    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition border border-gray-100 cursor-pointer flex flex-col h-full" onclick="app.openNovel('${novel.Id}')">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold text-gray-800 mb-2 truncate">${novel.Title}</h3>
                            <p class="text-gray-500 text-sm mb-4 line-clamp-3">${novel.Description}</p>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-400 pt-4 border-t mt-2">
                            <span>ä½œè€…: ${novel.Author.slice(0, 4)}...</span>
                            <span>${novel.Chapters ? Object.keys(novel.Chapters).length : 0} ç« èŠ‚</span>
                        </div>
                    </div>
                `).join('');
            }

            filterNovels(term) {
                let source = this.novels;
                if (this.isMyNovelsMode && this.wallet) {
                    source = this.novels.filter(n => n.Author === this.wallet);
                }
                const filtered = source.filter(n => 
                    n.Title.toLowerCase().includes(term.toLowerCase()) || 
                    n.Description.toLowerCase().includes(term.toLowerCase())
                );
                this.renderNovels(filtered);
            }

            async createNovel() {
                if (!this.wallet) return this.showToast("è¯·å…ˆè¿æ¥é’±åŒ…");
                const title = document.getElementById('new-novel-title').value;
                const desc = document.getElementById('new-novel-desc').value;
                if (!title || !desc) return this.showToast("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

                this.showToast("æ­£åœ¨åˆ›å»ºå°è¯´...");
                try {
                    await message({
                        process: PROCESS_ID,
                        tags: [
                            { name: "Action", value: "Create-Novel" },
                            { name: "Title", value: title },
                            { name: "Description", value: desc }
                        ],
                        signer: this.signer
                    });
                    this.showToast("åˆ›å»ºæˆåŠŸï¼");
                    document.getElementById('new-novel-title').value = '';
                    document.getElementById('new-novel-desc').value = '';
                    this.navigate('home');
                } catch (e) {
                    this.showToast("åˆ›å»ºå¤±è´¥: " + e.message);
                }
            }

            async openNovel(id) {
                this.currentNovel = this.novels.find(n => n.Id === id);
                if (!this.currentNovel) return;

                document.getElementById('detail-title').textContent = this.currentNovel.Title;
                document.getElementById('detail-desc').textContent = this.currentNovel.Description;
                document.getElementById('detail-author').textContent = "ä½œè€…: " + this.currentNovel.Author;
                
                this.checkAuthorControls();
                this.renderChapters();
                this.navigate('detail');
            }

            checkAuthorControls() {
                if (!this.currentNovel) return;
                const isOwner = this.wallet && this.wallet === this.currentNovel.Author;
                const controls = document.getElementById('author-controls');
                if (isOwner) controls.classList.remove('hidden');
                else controls.classList.add('hidden');
            }

            renderChapters() {
                const list = document.getElementById('chapter-list');
                const chapters = this.currentNovel.Chapters || [];
                
                if (chapters.length === 0) {
                    list.innerHTML = '<div class="text-gray-500 italic py-4 text-center bg-gray-50 rounded">æš‚æ— ç« èŠ‚</div>';
                    return;
                }

                list.innerHTML = chapters.map((chap, idx) => {
                    const index = idx + 1;
                    const isPaid = chap.IsPaid;
                    const price = chap.Price;
                    
                    return `
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition border border-transparent hover:border-gray-200">
                            <div class="flex items-center">
                                <span class="font-bold text-gray-500 mr-4 w-8">#${index}</span>
                                <div>
                                    <div class="font-medium text-gray-900">${chap.Title}</div>
                                    <div class="text-xs text-gray-400 mt-1">${chap.WordCount || 0} å­—</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                ${isPaid 
                                    ? `<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-medium border border-yellow-200">ä»˜è´¹: ${price} AO</span>` 
                                    : '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-medium border border-green-200">å…è´¹</span>'
                                }
                                <button onclick="app.readChapter(${index}, ${isPaid}, ${price})" class="text-primary font-bold hover:text-indigo-800 hover:underline px-2">é˜…è¯»</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            showAddChapterModal() {
                document.getElementById('chapter-title-input').value = '';
                document.getElementById('chapter-content-input').value = '';
                document.getElementById('chapter-is-paid').checked = false;
                document.getElementById('chapter-price-input').value = '';
                document.getElementById('chapter-price-input').disabled = true;
                document.getElementById('modal-add-chapter').classList.remove('hidden');
            }

            async addChapter() {
                const title = document.getElementById('chapter-title-input').value;
                const content = document.getElementById('chapter-content-input').value;
                const isPaid = document.getElementById('chapter-is-paid').checked;
                const price = document.getElementById('chapter-price-input').value || "0";

                if (!title || !content) return this.showToast("è¯·å¡«å†™å®Œæ•´ç« èŠ‚ä¿¡æ¯");

                this.showToast("æ­£åœ¨å‘å¸ƒç« èŠ‚...");
                try {
                    await message({
                        process: PROCESS_ID,
                        tags: [
                            { name: "Action", value: "Add-Chapter" },
                            { name: "NovelId", value: this.currentNovel.Id },
                            { name: "Title", value: title },
                            { name: "IsPaid", value: isPaid ? "true" : "false" },
                            { name: "Price", value: price }
                        ],
                        data: content,
                        signer: this.signer
                    });
                    
                    this.showToast("å‘å¸ƒæˆåŠŸï¼");
                    document.getElementById('modal-add-chapter').classList.add('hidden');
                    
                    await new Promise(r => setTimeout(r, 1000));
                    const res = await dryrun({
                        process: PROCESS_ID,
                        tags: [{ name: "Action", value: "Get-Novel" }, { name: "NovelId", value: this.currentNovel.Id }]
                    });
                    this.currentNovel = JSON.parse(res.Messages[0].Data);
                    this.renderChapters();
                } catch (e) {
                    this.showToast("å‘å¸ƒå¤±è´¥: " + e.message);
                }
            }

            async readChapter(index, isPaid, price) {
                const isAuthor = this.wallet && this.wallet === this.currentNovel.Author;
                if (isPaid && !isAuthor && !this.wallet) return this.showToast("ä»˜è´¹ç« èŠ‚è¯·å…ˆè¿æ¥é’±åŒ…");

                this.showToast("æ­£åœ¨åŠ è½½ç« èŠ‚...");
                try {
                    const res = await dryrun({
                        process: PROCESS_ID,
                        tags: [
                            { name: "Action", value: "Read-Chapter" },
                            { name: "NovelId", value: this.currentNovel.Id },
                            { name: "ChapterIndex", value: index.toString() }
                        ],
                        Owner: this.wallet || ""
                    });

                    const data = JSON.parse(res.Messages[0].Data);

                    if (data.Error === "Payment required.") {
                        if (confirm(`è¯¥ç« èŠ‚éœ€è¦æ”¯ä»˜ ${price} AOã€‚ç¡®è®¤è´­ä¹°å—ï¼Ÿ`)) {
                            await this.buyChapter(index, price);
                            this.readChapter(index, isPaid, price); 
                        }
                    } else if (data.Content) {
                        this.showReader(data.Title, data.Content);
                    } else {
                        this.showToast("æ— æ³•è¯»å–ç« èŠ‚å†…å®¹");
                    }
                } catch (e) {
                    console.error(e);
                    this.showToast("è¯»å–é”™è¯¯: " + e.message);
                }
            }

            async buyChapter(index, price) {
                this.showToast("æ­£åœ¨å‘èµ·æ”¯ä»˜...");
                try {
                    // Send AO Tokens to the Novel Process
                    await message({
                        process: AO_TOKEN_ID,
                        tags: [
                            { name: "Action", value: "Transfer" },
                            { name: "Recipient", value: PROCESS_ID },
                            { name: "Quantity", value: price.toString() },
                            { name: "X-Action", value: "Buy-Chapter" },
                            { name: "X-NovelId", value: this.currentNovel.Id },
                            { name: "X-ChapterIndex", value: index.toString() }
                        ],
                        signer: this.signer
                    });
                    
                    await new Promise(r => setTimeout(r, 2000));
                    this.showToast("è´­ä¹°æˆåŠŸï¼");
                } catch (e) {
                    this.showToast("è´­ä¹°å¤±è´¥: " + e.message);
                    throw e;
                }
            }

            showReader(title, content) {
                document.getElementById('reader-title').textContent = title;
                document.getElementById('reader-content').textContent = content;
                this.navigate('reader');
            }

            backToDetail() {
                this.navigate('detail');
            }

            showToast(msg) {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.classList.remove('translate-y-20');
                setTimeout(() => toast.classList.add('translate-y-20'), 3000);
            }
        }

        window.app = new App();
    </script>
</body>
</html>
