<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Platform Frontend</title>
    <!-- Browser bundle for aoconnect (bundles all deps, avoids module errors) -->
    <script src="https://unpkg.com/@permaweb/aoconnect/dist/browser.js"></script>
    <!-- common.js (no type="module" now) -->
    <script src="common.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        section { margin-bottom: 20px; }
        button { margin-right: 10px; }
        input, textarea { display: block; margin-bottom: 10px; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>Novel Platform</h1>
    <section id="wallet-section">
        <button id="connect-wallet">Connect Wallet (Wander)</button>
        <p>Wallet Address: <span id="wallet-address" class="wallet-address">Not connected</span></p>
    </section>
    <section id="create-novel">
        <h2>Create Novel</h2>
        <input id="novel-title" placeholder="Title" />
        <textarea id="novel-description" placeholder="Description"></textarea>
        <button id="create-novel-btn">Create</button>
        <pre id="create-result"></pre>
    </section>
    <section id="list-novels">
        <h2>List Novels</h2>
        <button id="list-novels-btn">List All Novels</button>
        <pre id="list-result"></pre>
    </section>
    <section id="get-novel">
        <h2>Get Novel Info</h2>
        <input id="novel-id" placeholder="Novel ID" />
        <button id="get-novel-btn">Get Info</button>
        <pre id="novel-result"></pre>
    </section>
    <section id="add-chapter">
        <h2>Add Chapter (Author Only)</h2>
        <input id="add-novel-id" placeholder="Novel ID" />
        <input id="chapter-title" placeholder="Chapter Title" />
        <textarea id="chapter-content" placeholder="Content"></textarea>
        <label>Is Paid: <input type="checkbox" id="is-paid" /></label>
        <input id="chapter-price" placeholder="Custom Price (optional)" type="number" />
        <button id="add-chapter-btn">Add</button>
        <pre id="add-result"></pre>
    </section>
    <section id="update-chapter">
        <h2>Update Chapter (Author Only)</h2>
        <input id="update-novel-id" placeholder="Novel ID" />
        <input id="chapter-index" placeholder="Chapter Index (1-based)" type="number" />
        <textarea id="new-content" placeholder="New Content"></textarea>
        <button id="update-chapter-btn">Update</button>
        <pre id="update-result"></pre>
    </section>
    <section id="buy-chapter">
        <h2>Buy Chapter</h2>
        <input id="buy-novel-id" placeholder="Novel ID" />
        <input id="buy-chapter-index" placeholder="Chapter Index" type="number" />
        <button id="buy-chapter-btn">Buy</button>
        <pre id="buy-result"></pre>
    </section>
    <section id="read-chapter">
        <h2>Read Chapter</h2>
        <input id="read-novel-id" placeholder="Novel ID" />
        <input id="read-chapter-index" placeholder="Chapter Index" type="number" />
        <button id="read-chapter-btn">Read</button>
        <pre id="read-result"></pre>
    </section>
    <section id="get-earnings">
        <h2>Get Earnings</h2>
        <button id="get-earnings-btn">Get My Earnings</button>
        <pre id="earnings-result"></pre>
    </section>
    <script>
        window.addEventListener('load', () => {
            if (!window.connectWallet) {
                alert('common.js 未加载成功 - 请检查网络，尝试 Ctrl+Shift+R 刷新。');
                return;
            }
            document.getElementById('connect-wallet').addEventListener('click', window.connectWallet);

            // Create Novel
            document.getElementById('create-novel-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包!');
                const title = document.getElementById('novel-title').value;
                const desc = document.getElementById('novel-description').value;
                const tags = [
                    { name: 'Action', value: 'Create-Novel' },
                    { name: 'Title', value: title },
                    { name: 'Description', value: desc }
                ];
                try {
                    const output = await window.aoMessage(tags);
                    document.getElementById('create-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });

            // List Novels
            document.getElementById('list-novels-btn').addEventListener('click', async () => {
                const tags = [{ name: 'Action', value: 'List-Novels' }];
                try {
                    const output = await window.aoDryrun(tags);
                    document.getElementById('list-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });

            // Get Novel
            document.getElementById('get-novel-btn').addEventListener('click', async () => {
                const id = document.getElementById('novel-id').value;
                const tags = [
                    { name: 'Action', value: 'Get-Novel' },
                    { name: 'NovelId', value: id }
                ];
                try {
                    const output = await window.aoDryrun(tags);
                    document.getElementById('novel-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });

            // Add Chapter
            document.getElementById('add-chapter-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包!');
                const id = document.getElementById('add-novel-id').value;
                const title = document.getElementById('chapter-title').value;
                const content = document.getElementById('chapter-content').value;
                const isPaid = document.getElementById('is-paid').checked ? 'true' : 'false';
                const price = document.getElementById('chapter-price').value || '0';
                const tags = [
                    { name: 'Action', value: 'Add-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'Title', value: title },
                    { name: 'IsPaid', value: isPaid },
                    { name: 'Price', value: price }
                ];
                try {
                    const output = await window.aoMessage(tags, content);
                    document.getElementById('add-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });

            // Update Chapter
            document.getElementById('update-chapter-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包!');
                const id = document.getElementById('update-novel-id').value;
                const index = document.getElementById('chapter-index').value;
                const content = document.getElementById('new-content').value;
                const tags = [
                    { name: 'Action', value: 'Update-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ];
                try {
                    const output = await window.aoMessage(tags, content);
                    document.getElementById('update-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });

            // Buy Chapter
            document.getElementById('buy-chapter-btn').addEventListener('click', async () => {
                if (!window.walletAddress) return alert('请先连接钱包!');
                const id = document.getElementById('buy-novel-id').value;
                const index = document.getElementById('buy-chapter-index').value;
                const tags = [
                    { name: 'Action', value: 'Buy-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ];
                try {
                    const output = await window.aoMessage(tags);
                    document.getElementById('buy-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });

            // Read Chapter
            document.getElementById('read-chapter-btn').addEventListener('click', async () => {
                const id = document.getElementById('read-novel-id').value;
                const index = document.getElementById('read-chapter-index').value;
                const tags = [
                    { name: 'Action', value: 'Read-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ];
                try {
                    const output = await window.aoDryrun(tags);
                    document.getElementById('read-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });

            // Get Earnings
            document.getElementById('get-earnings-btn').addEventListener('click', async () => {
                const tags = [{ name: 'Action', value: 'Get-Earnings' }];
                try {
                    const output = await window.aoDryrun(tags);
                    document.getElementById('earnings-result').textContent = output;
                } catch (e) {
                    alert('AO 操作失败: ' + e.message);
                }
            });
        });
    </script>
</body>
</html>
