<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AO å°è¯´å¹³å°</title>
    <!-- ä½¿ç”¨ jsDelivr æä¾›çš„ ESM ç‰ˆæœ¬ + importmap è§£å†³æµè§ˆå™¨å…¼å®¹ -->
    <script type="importmap">
    {
      "imports": {
        "@permaweb/aoconnect": "https://cdn.jsdelivr.net/npm/@permaweb/aoconnect@0.0.93/+esm"
      }
    }
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f4f8; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        h2 { color: #444; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #4a6cf7; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #3a5be6; }
        pre { background: #eee; padding: 15px; border-radius: 4px; white-space: pre-wrap; max-height: 300px; overflow: auto; }
        .wallet-status { font-weight: bold; color: #d32f2f; }
        .connected { color: #2e7d32; }
        small { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š AO å°è¯´å¹³å°</h1>

        <section>
            <button id="connect-wallet">è¿æ¥ Wander é’±åŒ…</button>
            <p>é’±åŒ…åœ°å€: <span id="wallet-address" class="wallet-status">æœªè¿æ¥</span></p>
            <small>âš ï¸ å¿…é¡»å…ˆç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’ Wander å›¾æ ‡ï¼ˆâ›µï¸ï¼‰è¾“å…¥å¯†ç å®Œå…¨è§£é”é’±åŒ…ï¼å¦åˆ™ä¼šæŠ¥ "auth required"</small>
        </section>

        <section>
            <h2>åˆ›å»ºå°è¯´</h2>
            <input id="novel-title" placeholder="æ ‡é¢˜" />
            <textarea id="novel-description" placeholder="ç®€ä»‹"></textarea>
            <button id="create-novel-btn">åˆ›å»º</button>
            <pre id="create-result"></pre>
        </section>

        <section>
            <h2>å°è¯´åˆ—è¡¨</h2>
            <button id="list-novels-btn">æŸ¥è¯¢æ‰€æœ‰å°è¯´</button>
            <pre id="list-result"></pre>
        </section>

        <section>
            <h2>å°è¯´è¯¦æƒ…</h2>
            <input id="novel-id" placeholder="å°è¯´ ID" />
            <button id="get-novel-btn">æŸ¥è¯¢</button>
            <pre id="novel-result"></pre>
        </section>

        <section>
            <h2>æ·»åŠ ç« èŠ‚ï¼ˆä»…ä½œè€…ï¼‰</h2>
            <input id="add-novel-id" placeholder="å°è¯´ ID" />
            <input id="chapter-title" placeholder="ç« èŠ‚æ ‡é¢˜" />
            <textarea id="chapter-content" placeholder="ç« èŠ‚å†…å®¹"></textarea>
            <label><input type="checkbox" id="is-paid"> ä»˜è´¹ç« èŠ‚</label>
            <input id="chapter-price" type="number" placeholder="ä»·æ ¼ (ARï¼Œå¯ç•™ç©ºé»˜è®¤0)" />
            <button id="add-chapter-btn">æ·»åŠ </button>
            <pre id="add-result"></pre>
        </section>

        <section>
            <h2>æ›´æ–°ç« èŠ‚ï¼ˆä»…ä½œè€…ï¼‰</h2>
            <input id="update-novel-id" placeholder="å°è¯´ ID" />
            <input id="chapter-index" type="number" placeholder="ç« èŠ‚åºå· (ä»1å¼€å§‹)" />
            <textarea id="new-content" placeholder="æ–°å†…å®¹"></textarea>
            <button id="update-chapter-btn">æ›´æ–°</button>
            <pre id="update-result"></pre>
        </section>

        <section>
            <h2>è´­ä¹°ç« èŠ‚</h2>
            <input id="buy-novel-id" placeholder="å°è¯´ ID" />
            <input id="buy-chapter-index" type="number" placeholder="ç« èŠ‚åºå·" />
            <button id="buy-chapter-btn">è´­ä¹°</button>
            <pre id="buy-result"></pre>
        </section>

        <section>
            <h2>é˜…è¯»ç« èŠ‚</h2>
            <input id="read-novel-id" placeholder="å°è¯´ ID" />
            <input id="read-chapter-index" type="number" placeholder="ç« èŠ‚åºå·" />
            <button id="read-chapter-btn">é˜…è¯»</button>
            <pre id="read-result"></pre>
        </section>

        <section>
            <h2>æˆ‘çš„æ”¶ç›Š</h2>
            <button id="get-earnings-btn">æŸ¥è¯¢æ”¶ç›Š</button>
            <pre id="earnings-result"></pre>
        </section>
    </div>

    <script type="module">
        import { message, result, dryrun, createDataItemSigner } from "@permaweb/aoconnect";

        const PROCESS_ID = "51tMVLxBazWMBT9NhfaCuDP3HjQfZOggIcT7l9mRrbw";

        let signer = null;
        let walletAddress = null;

        function updateWalletDisplay(addr) {
            walletAddress = addr;
            const span = document.getElementById('wallet-address');
            const btn = document.getElementById('connect-wallet');
            if (addr) {
                span.textContent = addr.slice(0, 6) + '...' + addr.slice(-4);
                span.classList.add('connected');
                btn.textContent = 'å·²è¿æ¥';
                btn.disabled = true;
            } else {
                span.textContent = 'æœªè¿æ¥';
                span.classList.remove('connected');
                btn.textContent = 'è¿æ¥ Wander é’±åŒ…';
                btn.disabled = false;
            }
        }

        async function connectWallet() {
            if (!window.arweaveWallet) {
                alert('æœªæ£€æµ‹åˆ° Wander æ‰©å±•ï¼è¯·å®‰è£… https://www.wander.app/download å¹¶åˆ·æ–°é¡µé¢');
                return;
            }

            try {
                await window.arweaveWallet.connect(['ACCESS_ADDRESS', 'SIGN_TRANSACTION', 'SIGNATURE']);
                const addr = await window.arweaveWallet.getActiveAddress();
                signer = createDataItemSigner(window.arweaveWallet);
                updateWalletDisplay(addr);
                alert('é’±åŒ…è¿æ¥æˆåŠŸï¼');
            } catch (err) {
                let msg = err.message || '';
                if (msg.includes('auth required')) {
                    msg = 'é’±åŒ…æœªè§£é”ï¼è¯·ç‚¹å‡» Wander å›¾æ ‡è¾“å…¥å¯†ç è§£é”åå†è¯•';
                }
                alert('è¿æ¥å¤±è´¥ï¼š' + msg + '\nè¯·æ£€æŸ¥ Wander æ˜¯å¦è§£é”å¹¶æ‰¹å‡†æƒé™');
                console.error(err);
            }
        }

        document.getElementById('connect-wallet').addEventListener('click', connectWallet);

        // æŸ¥è¯¢æ“ä½œï¼ˆdryrunï¼‰
        async function aoDryrun(tags) {
            const res = await dryrun({ process: PROCESS_ID, tags });
            return res.Messages?.[0]?.Data || JSON.stringify(res, null, 2);
        }

        // å†™å…¥æ“ä½œï¼ˆmessage + resultï¼‰
        async function aoMessage(tags, data = '') {
            if (!signer) throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
            const msgId = await message({ process: PROCESS_ID, signer, tags, data });
            const res = await result({ message: msgId, process: PROCESS_ID });
            return res.Output || res.Messages?.[0]?.Data || JSON.stringify(res, null, 2);
        }

        // æ‰€æœ‰æŒ‰é’®äº‹ä»¶
        document.getElementById('create-novel-btn').addEventListener('click', async () => {
            const title = document.getElementById('novel-title').value;
            const desc = document.getElementById('novel-description').value;
            if (!title || !desc) return alert('æ ‡é¢˜å’Œç®€ä»‹å¿…å¡«');
            try {
                const out = await aoMessage([
                    { name: 'Action', value: 'Create-Novel' },
                    { name: 'Title', value: title },
                    { name: 'Description', value: desc }
                ]);
                document.getElementById('create-result').textContent = out;
            } catch (e) {
                document.getElementById('create-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        document.getElementById('list-novels-btn').addEventListener('click', async () => {
            try {
                const out = await aoDryrun([{ name: 'Action', value: 'List-Novels' }]);
                document.getElementById('list-result').textContent = out;
            } catch (e) {
                document.getElementById('list-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        document.getElementById('get-novel-btn').addEventListener('click', async () => {
            const id = document.getElementById('novel-id').value;
            if (!id) return alert('è¯·è¾“å…¥å°è¯´ID');
            try {
                const out = await aoDryrun([
                    { name: 'Action', value: 'Get-Novel' },
                    { name: 'NovelId', value: id }
                ]);
                document.getElementById('novel-result').textContent = out;
            } catch (e) {
                document.getElementById('novel-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        document.getElementById('add-chapter-btn').addEventListener('click', async () => {
            const id = document.getElementById('add-novel-id').value;
            const title = document.getElementById('chapter-title').value;
            const content = document.getElementById('chapter-content').value;
            const isPaid = document.getElementById('is-paid').checked ? 'true' : 'false';
            const price = document.getElementById('chapter-price').value || '0';
            if (!id || !title || !content) return alert('å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©º');
            try {
                const out = await aoMessage([
                    { name: 'Action', value: 'Add-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'Title', value: title },
                    { name: 'IsPaid', value: isPaid },
                    { name: 'Price', value: price }
                ], content);
                document.getElementById('add-result').textContent = out;
            } catch (e) {
                document.getElementById('add-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        document.getElementById('update-chapter-btn').addEventListener('click', async () => {
            const id = document.getElementById('update-novel-id').value;
            const index = document.getElementById('chapter-index').value;
            const content = document.getElementById('new-content').value;
            if (!id || !index || !content) return alert('å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©º');
            try {
                const out = await aoMessage([
                    { name: 'Action', value: 'Update-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ], content);
                document.getElementById('update-result').textContent = out;
            } catch (e) {
                document.getElementById('update-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        document.getElementById('buy-chapter-btn').addEventListener('click', async () => {
            const id = document.getElementById('buy-novel-id').value;
            const index = document.getElementById('buy-chapter-index').value;
            if (!id || !index) return alert('å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©º');
            try {
                const out = await aoMessage([
                    { name: 'Action', value: 'Buy-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ]);
                document.getElementById('buy-result').textContent = out;
            } catch (e) {
                document.getElementById('buy-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        document.getElementById('read-chapter-btn').addEventListener('click', async () => {
            const id = document.getElementById('read-novel-id').value;
            const index = document.getElementById('read-chapter-index').value;
            if (!id || !index) return alert('å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©º');
            try {
                const out = await aoDryrun([
                    { name: 'Action', value: 'Read-Chapter' },
                    { name: 'NovelId', value: id },
                    { name: 'ChapterIndex', value: index }
                ]);
                document.getElementById('read-result').textContent = out;
            } catch (e) {
                document.getElementById('read-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        document.getElementById('get-earnings-btn').addEventListener('click', async () => {
            try {
                const out = await aoDryrun([{ name: 'Action', value: 'Get-Earnings' }]);
                document.getElementById('earnings-result').textContent = out;
            } catch (e) {
                document.getElementById('earnings-result').textContent = 'é”™è¯¯: ' + e.message;
            }
        });

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿æ¥
        window.addEventListener('load', async () => {
            if (window.arweaveWallet) {
                try {
                    const addr = await window.arweaveWallet.getActiveAddress();
                    if (addr) {
                        signer = createDataItemSigner(window.arweaveWallet);
                        updateWalletDisplay(addr);
                    }
                } catch (e) {
                    console.log('æ— æ´»è·ƒä¼šè¯');
                }
            }
        });
    </script>
</body>
</html>
