<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOå°è¯´å¹³å° - ä½œè€…åå°</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š ä½œè€…åå°</h1>
            <p>åˆ›å»ºå°è¯´ Â· æ·»åŠ ç« èŠ‚ Â· æŸ¥çœ‹æ”¶ç›Š</p>
        </header>

        <div class="wallet-section">
            <h2>ğŸ’³ é’±åŒ…è¿æ¥ï¼ˆå¿…é¡»ï¼‰</h2>
            <button id="connect-wallet">è¿æ¥Wanderé’±åŒ…</button>
            <p>é’±åŒ…åœ°å€: <span class="wallet-address status-disconnected">æœªè¿æ¥</span></p>
        </div>

        <h2>ğŸ“– åˆ›å»ºå°è¯´</h2>
        <div class="input-group" style="display:flex;flex-direction:column;gap:12px;">
            <input id="novel-title" placeholder="å°è¯´æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰" maxlength="100" />
            <textarea id="novel-description" placeholder="å°è¯´ç®€ä»‹ï¼ˆå¿…å¡«ï¼‰" maxlength="500"></textarea>
            <button id="create-novel-btn">ğŸš€ åˆ›å»ºå°è¯´</button>
        </div>
        <pre id="create-result">ç‚¹å‡»åˆ›å»ºåæ˜¾ç¤ºæ¶ˆæ¯IDï¼Œç¨ååˆ·æ–°æˆ‘çš„å°è¯´åˆ—è¡¨ç¡®è®¤</pre>

        <h2>ğŸ“‹ æˆ‘çš„å°è¯´åˆ—è¡¨</h2>
        <button id="my-novels-btn">ğŸ” åˆ·æ–°æˆ‘çš„å°è¯´</button>
        <div id="my-novels-list" style="margin-top:16px;"></div>

        <h2>âœ¨ æ·»åŠ ç« èŠ‚ï¼ˆä»…è‡ªå·±çš„å°è¯´ï¼‰</h2>
        <div class="input-group" style="display:flex;flex-direction:column;gap:12px;">
            <input id="add-novel-id" placeholder="å°è¯´IDï¼ˆå¿…å¡«ï¼‰" />
            <input id="chapter-title" placeholder="ç« èŠ‚æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰" maxlength="100" />
            <textarea id="chapter-content" placeholder="ç« èŠ‚æ­£æ–‡å†…å®¹ï¼ˆå¿…å¡«ï¼‰" maxlength="10000"></textarea>
            <label style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" id="is-paid" /> ä»˜è´¹ç« èŠ‚
            </label>
            <input id="chapter-price" type="number" min="0" step="1" placeholder="ä»·æ ¼ï¼ˆCreditsï¼Œé»˜è®¤0å…è´¹ï¼‰" />
            <button id="add-chapter-btn">ğŸ“ æ·»åŠ ç« èŠ‚</button>
        </div>
        <pre id="add-result">å¡«å†™å®Œæ•´åç‚¹å‡»æ·»åŠ </pre>

        <h2>ğŸ”§ æ›´æ–°ç« èŠ‚ï¼ˆä»…è‡ªå·±çš„å°è¯´ï¼‰</h2>
        <div class="input-group" style="display:flex;flex-direction:column;gap:12px;">
            <input id="update-novel-id" placeholder="å°è¯´IDï¼ˆå¿…å¡«ï¼‰" />
            <input id="chapter-index" type="number" min="1" placeholder="ç« èŠ‚åºå·ï¼ˆä»1å¼€å§‹ï¼Œå¿…å¡«ï¼‰" />
            <textarea id="new-content" placeholder="æ–°çš„ç« èŠ‚å†…å®¹ï¼ˆå¿…å¡«ï¼‰" maxlength="10000"></textarea>
            <button id="update-chapter-btn">ğŸ’¾ æ›´æ–°ç« èŠ‚</button>
        </div>
        <pre id="update-result">å¡«å†™å®Œæ•´åç‚¹å‡»æ›´æ–°</pre>

        <h2>ğŸ’µ æˆ‘çš„æ€»æ”¶ç›Š</h2>
        <button id="get-earnings-btn">ğŸ’° æŸ¥è¯¢æ”¶ç›Š</button>
        <pre id="earnings-result">ç‚¹å‡»æŸ¥è¯¢ï¼ˆæ˜¾ç¤ºCreditsï¼‰</pre>
    </div>

    <script type="module" src="common.js"></script>
    <script type="module">
        import { connectWallet, dryRun, sendMessage, listAllNovels } from "./common.js";

        document.getElementById('connect-wallet').addEventListener('click', connectWallet);

        // åˆ›å»ºå°è¯´
        document.getElementById('create-novel-btn').addEventListener('click', async () => {
            if (!document.querySelector('.wallet-address').textContent.includes('ao')) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const title = document.getElementById('novel-title').value.trim();
            const desc = document.getElementById('novel-description').value.trim();
            if (!title || !desc) return alert('æ ‡é¢˜å’Œç®€ä»‹ä¸èƒ½ä¸ºç©º');

            const btn = document.getElementById('create-novel-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const tags = [
                    { name: 'Title', value: title },
                    { name: 'Description', value: desc }
                ];
                const msgId = await sendMessage('Create-Novel', tags);
                document.getElementById('create-result').textContent = `âœ… æ¶ˆæ¯å·²å‘é€ï¼ID: ${msgId}\nè¯·ç¨ååˆ·æ–°æˆ‘çš„å°è¯´åˆ—è¡¨ç¡®è®¤ã€‚`;
            } catch (e) {
                document.getElementById('create-result').textContent = `âŒ åˆ›å»ºå¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æˆ‘çš„å°è¯´åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºå½“å‰é’±åŒ…åœ°å€åˆ›å»ºçš„å°è¯´ï¼‰
        document.getElementById('my-novels-btn').addEventListener('click', async () => {
            const address = document.querySelector('.wallet-address').textContent;
            if (!address.includes('ao')) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');

            const btn = document.getElementById('my-novels-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const all = await listAllNovels();
                const mine = all.filter(n => n.author === address);
                const container = document.getElementById('my-novels-list');
                container.innerHTML = '';
                if (mine.length === 0) {
                    container.innerHTML = '<p>ä½ è¿˜æ²¡æœ‰åˆ›å»ºå°è¯´</p>';
                    return;
                }
                mine.forEach(novel => {
                    const card = document.createElement('div');
                    card.className = 'novel-card';
                    card.innerHTML = `
                        <strong>${novel.title}</strong><br>
                        ID: ${novel.id}<br>
                        ç« èŠ‚æ•°: ${novel.chapters?.length || 0}
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                alert('åŠ è½½å¤±è´¥: ' + e.message);
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æ·»åŠ ç« èŠ‚
        document.getElementById('add-chapter-btn').addEventListener('click', async () => {
            if (!document.querySelector('.wallet-address').textContent.includes('ao')) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const novelId = document.getElementById('add-novel-id').value.trim();
            const title = document.getElementById('chapter-title').value.trim();
            const content = document.getElementById('chapter-content').value.trim();
            if (!novelId || !title || !content) return alert('å°è¯´IDã€æ ‡é¢˜ã€å†…å®¹ä¸èƒ½ä¸ºç©º');

            const btn = document.getElementById('add-chapter-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const tags = [
                    { name: 'NovelId', value: novelId },
                    { name: 'Title', value: title },
                    { name: 'IsPaid', value: document.getElementById('is-paid').checked ? 'true' : 'false' },
                    { name: 'Price', value: document.getElementById('chapter-price').value || '0' }
                ];
                const msgId = await sendMessage('Add-Chapter', tags, content);
                document.getElementById('add-result').textContent = `âœ… æ¶ˆæ¯å·²å‘é€ï¼ID: ${msgId}`;
            } catch (e) {
                document.getElementById('add-result').textContent = `âŒ æ·»åŠ å¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æ›´æ–°ç« èŠ‚
        document.getElementById('update-chapter-btn').addEventListener('click', async () => {
            if (!document.querySelector('.wallet-address').textContent.includes('ao')) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const novelId = document.getElementById('update-novel-id').value.trim();
            const index = document.getElementById('chapter-index').value.trim();
            const content = document.getElementById('new-content').value.trim();
            if (!novelId || !index || !content) return alert('æ‰€æœ‰å­—æ®µä¸èƒ½ä¸ºç©º');

            const btn = document.getElementById('update-chapter-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const tags = [
                    { name: 'NovelId', value: novelId },
                    { name: 'ChapterIndex', value: index }
                ];
                const msgId = await sendMessage('Update-Chapter', tags, content);
                document.getElementById('update-result').textContent = `âœ… æ¶ˆæ¯å·²å‘é€ï¼ID: ${msgId}`;
            } catch (e) {
                document.getElementById('update-result').textContent = `âŒ æ›´æ–°å¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æŸ¥è¯¢æ”¶ç›Š
        document.getElementById('get-earnings-btn').addEventListener('click', async () => {
            if (!document.querySelector('.wallet-address').textContent.includes('ao')) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const btn = document.getElementById('get-earnings-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const output = await dryRun('Get-Earnings');
                document.getElementById('earnings-result').textContent = output;
            } catch (e) {
                document.getElementById('earnings-result').textContent = `âŒ æŸ¥è¯¢å¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });
    </script>
</body>
</html>
