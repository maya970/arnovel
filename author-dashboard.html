<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOå°è¯´å¹³å° - ä½œè€…åå°</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š ä½œè€…åå°</h1>
            <p>åˆ›å»ºå°è¯´ Â· æ·»åŠ ç« èŠ‚ Â· æŸ¥çœ‹æ”¶ç›Š</p>
        </header>

        <div class="wallet-section">
            <h2>ğŸ’³ é’±åŒ…è¿æ¥ï¼ˆå¿…é¡»ï¼‰</h2>
            <button id="connect-wallet">è¿æ¥Wanderé’±åŒ…</button>
            <p>é’±åŒ…åœ°å€: <span class="wallet-address status-disconnected">æœªè¿æ¥</span></p>
        </div>

        <h2>ğŸ“– åˆ›å»ºå°è¯´</h2>
        <div style="display:flex;flex-direction:column;gap:12px;max-width:600px;">
            <input id="novel-title" placeholder="å°è¯´æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰" maxlength="100" />
            <textarea id="novel-description" placeholder="å°è¯´ç®€ä»‹ï¼ˆå¿…å¡«ï¼‰" maxlength="500" style="min-height:120px;"></textarea>
            <button id="create-novel-btn">ğŸš€ åˆ›å»ºå°è¯´</button>
        </div>
        <pre id="create-result" style="margin-top:16px;">åˆ›å»ºåå°†æ˜¾ç¤ºæ¶ˆæ¯ID</pre>

        <h2>ğŸ“‹ æˆ‘çš„å°è¯´åˆ—è¡¨</h2>
        <button id="my-novels-btn">ğŸ” åˆ·æ–°åˆ—è¡¨</button>
        <div id="my-novels-list" style="margin-top:16px;"></div>

        <h2>âœ¨ æ·»åŠ ç« èŠ‚</h2>
        <div style="display:flex;flex-direction:column;gap:12px;max-width:600px;">
            <input id="add-novel-id" placeholder="å°è¯´IDï¼ˆå¿…å¡«ï¼‰" />
            <input id="chapter-title" placeholder="ç« èŠ‚æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰" maxlength="100" />
            <textarea id="chapter-content" placeholder="ç« èŠ‚æ­£æ–‡å†…å®¹ï¼ˆå¿…å¡«ï¼‰" maxlength="10000" style="min-height:200px;"></textarea>
            <label style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" id="is-paid" /> ä»˜è´¹ç« èŠ‚
            </label>
            <input id="chapter-price" type="number" min="0" step="1" placeholder="ä»·æ ¼ï¼ˆCreditsï¼Œé»˜è®¤0å…è´¹ï¼‰" />
            <button id="add-chapter-btn">ğŸ“ æ·»åŠ ç« èŠ‚</button>
        </div>
        <pre id="add-result" style="margin-top:16px;">æ“ä½œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</pre>

        <h2>ğŸ”§ æ›´æ–°ç« èŠ‚</h2>
        <div style="display:flex;flex-direction:column;gap:12px;max-width:600px;">
            <input id="update-novel-id" placeholder="å°è¯´IDï¼ˆå¿…å¡«ï¼‰" />
            <input id="chapter-index" type="number" min="1" placeholder="ç« èŠ‚åºå·ï¼ˆä»1å¼€å§‹ï¼Œå¿…å¡«ï¼‰" />
            <textarea id="new-content" placeholder="æ–°çš„ç« èŠ‚å†…å®¹ï¼ˆå¿…å¡«ï¼‰" maxlength="10000" style="min-height:200px;"></textarea>
            <button id="update-chapter-btn">ğŸ’¾ æ›´æ–°ç« èŠ‚</button>
        </div>
        <pre id="update-result" style="margin-top:16px;">æ“ä½œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</pre>

        <h2>ğŸ’µ æˆ‘çš„æ€»æ”¶ç›Š</h2>
        <button id="get-earnings-btn">ğŸ’° æŸ¥è¯¢æ”¶ç›Š</button>
        <pre id="earnings-result" style="margin-top:16px;">ç‚¹å‡»æŸ¥è¯¢åæ˜¾ç¤ºCreditsæ•°é‡</pre>
    </div>

    <script type="module" src="common.js"></script>
    <script type="module">
        import { connectWallet, sendMessage, dryRun, listAllNovels, walletAddress } from "./common.js";

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤é’±åŒ…çŠ¶æ€å¹¶æ›´æ–°UI
        if (walletAddress) {
            document.querySelector('.wallet-address').textContent = walletAddress;
            document.querySelector('.wallet-address').className = 'wallet-status status-connected';
            document.getElementById('connect-wallet').textContent = 'é’±åŒ…å·²è¿æ¥';
            document.getElementById('connect-wallet').disabled = true;
        }

        document.getElementById('connect-wallet').addEventListener('click', connectWallet);

        // åˆ›å»ºå°è¯´
        document.getElementById('create-novel-btn').addEventListener('click', async () => {
            if (!walletAddress) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const title = document.getElementById('novel-title').value.trim();
            const desc = document.getElementById('novel-description').value.trim();
            if (!title || !desc) return alert('æ ‡é¢˜å’Œç®€ä»‹ä¸èƒ½ä¸ºç©º');

            const btn = document.getElementById('create-novel-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const tags = [
                    { name: 'Title', value: title },
                    { name: 'Description', value: desc }
                ];
                const res = await sendMessage('Create-Novel', tags);
                document.getElementById('create-result').textContent = 
                    `âœ… æ¶ˆæ¯å·²å‘é€ï¼æ¶ˆæ¯ID: ${res}\nå°è¯´åˆ›å»ºæˆåŠŸï¼Œè¯·ç¨ååˆ·æ–°â€œæˆ‘çš„å°è¯´åˆ—è¡¨â€æŸ¥çœ‹æ–°å°è¯´ã€‚`;
            } catch (e) {
                document.getElementById('create-result').textContent = `âŒ åˆ›å»ºå¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æˆ‘çš„å°è¯´åˆ—è¡¨ï¼ˆè‡ªåŠ¨è¿‡æ»¤å½“å‰ä½œè€…ï¼‰
        document.getElementById('my-novels-btn').addEventListener('click', async () => {
            if (!walletAddress) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const btn = document.getElementById('my-novels-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const allNovels = await listAllNovels();
                const myNovels = allNovels.filter(n => n.author === walletAddress);
                const container = document.getElementById('my-novels-list');
                container.innerHTML = '';
                if (myNovels.length === 0) {
                    container.innerHTML = '<p style="color:#999;">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•å°è¯´</p>';
                    return;
                }
                myNovels.forEach(novel => {
                    const card = document.createElement('div');
                    card.className = 'novel-card';
                    card.innerHTML = `
                        <strong>${novel.title || 'æ— æ ‡é¢˜'}</strong><br>
                        <small>ID: ${novel.id}</small><br>
                        <small>ç« èŠ‚æ•°: ${novel.chapters?.length || 0}</small>
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                container.innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æ·»åŠ ç« èŠ‚
        document.getElementById('add-chapter-btn').addEventListener('click', async () => {
            if (!walletAddress) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const novelId = document.getElementById('add-novel-id').value.trim();
            const title = document.getElementById('chapter-title').value.trim();
            const content = document.getElementById('chapter-content').value.trim();
            if (!novelId || !title || !content) return alert('å°è¯´IDã€ç« èŠ‚æ ‡é¢˜ã€æ­£æ–‡å†…å®¹ä¸èƒ½ä¸ºç©º');

            const btn = document.getElementById('add-chapter-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const tags = [
                    { name: 'NovelId', value: novelId },
                    { name: 'Title', value: title },
                    { name: 'IsPaid', value: document.getElementById('is-paid').checked ? 'true' : 'false' },
                    { name: 'Price', value: document.getElementById('chapter-price').value || '0' }
                ];
                const res = await sendMessage('Add-Chapter', tags, content);
                document.getElementById('add-result').textContent = `âœ… ç« èŠ‚æ·»åŠ æˆåŠŸï¼æ¶ˆæ¯ID: ${res}`;
            } catch (e) {
                document.getElementById('add-result').textContent = `âŒ æ·»åŠ å¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æ›´æ–°ç« èŠ‚
        document.getElementById('update-chapter-btn').addEventListener('click', async () => {
            if (!walletAddress) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const novelId = document.getElementById('update-novel-id').value.trim();
            const index = document.getElementById('chapter-index').value;
            const content = document.getElementById('new-content').value.trim();
            if (!novelId || !index || !content) return alert('æ‰€æœ‰å­—æ®µéƒ½å¿…é¡»å¡«å†™');

            const btn = document.getElementById('update-chapter-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const tags = [
                    { name: 'NovelId', value: novelId },
                    { name: 'ChapterIndex', value: index }
                ];
                const res = await sendMessage('Update-Chapter', tags, content);
                document.getElementById('update-result').textContent = `âœ… ç« èŠ‚æ›´æ–°æˆåŠŸï¼æ¶ˆæ¯ID: ${res}`;
            } catch (e) {
                document.getElementById('update-result').textContent = `âŒ æ›´æ–°å¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });

        // æŸ¥è¯¢æ”¶ç›Š
        document.getElementById('get-earnings-btn').addEventListener('click', async () => {
            if (!walletAddress) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
            const btn = document.getElementById('get-earnings-btn');
            btn.disabled = true; btn.classList.add('loading');
            try {
                const result = await dryRun('Get-Earnings');
                document.getElementById('earnings-result').textContent = result.trim() || '0 Credits';
            } catch (e) {
                document.getElementById('earnings-result').textContent = `âŒ æŸ¥è¯¢å¤±è´¥: ${e.message}`;
            } finally {
                btn.disabled = false; btn.classList.remove('loading');
            }
        });
    </script>
</body>
</html>
