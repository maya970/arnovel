<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阅读章节</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="chapter-title">加载中...</h1>
        </header>

        <div class="wallet-section">
            <button id="connect-wallet">连接Wander钱包</button>
            <p>钱包地址: <span class="wallet-address status-disconnected">未连接</span></p>
        </div>

        <div id="chapter-content">加载中...</div>

        <button id="prev-btn" class="nav-btn">← 上一章</button>
        <div id="chapter-info">加载中...</div>
        <button id="next-btn" class="nav-btn">下一章 →</button>
    </div>

    <script type="module" src="common.js"></script>
    <script type="module">
        import { connectWallet, readChapter, getNovel } from "./common.js";

        document.getElementById('connect-wallet')?.addEventListener('click', connectWallet);

        const params = new URLSearchParams(location.search);
        const novelId = params.get('novel');
        let currentIdx = parseInt(params.get('ch')) || 1;

        if (!novelId) {
            alert('缺少小说ID');
            location.href = 'index.html';
        }

        async function loadChapter() {
            try {
                const content = await readChapter(novelId, currentIdx);
                document.getElementById('chapter-content').textContent = content || '章节内容为空';

                const novel = await getNovel(novelId);
                const chapter = novel.chapters[currentIdx - 1];
                document.getElementById('chapter-title').textContent = `第${currentIdx}章 ${chapter.title || '无标题'}`;
                document.title = `第${currentIdx}章 - ${novel.title}`;

                document.getElementById('chapter-info').textContent = `${currentIdx} / ${novel.chapters.length}`;

                document.getElementById('prev-btn').disabled = currentIdx <= 1;
                document.getElementById('next-btn').disabled = currentIdx >= novel.chapters.length;
            } catch (e) {
                document.getElementById('chapter-content').textContent = `读取失败：${e.message}\n可能原因：付费章节未购买、内容不存在或进程错误。`;
            }
        }

        document.getElementById('prev-btn').onclick = () => {
            if (currentIdx > 1) location.href = `chapter.html?novel=${novelId}&ch=${--currentIdx}`;
        };
        document.getElementById('next-btn').onclick = () => {
            location.href = `chapter.html?novel=${novelId}&ch=${++currentIdx}`;
        };

        document.onkeydown = (e) => {
            if (e.key === 'ArrowLeft') document.getElementById('prev-btn').onclick();
            if (e.key === 'ArrowRight') document.getElementById('next-btn').onclick();
        };

        loadChapter();
    </script>
</body>
</html>
